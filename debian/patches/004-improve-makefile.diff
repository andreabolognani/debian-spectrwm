Description: Improve GNU/Linux Makefile
 Make sure to use all the build flags that can be expected in the
 environment, overriding the maintainer build flags if necessary;
 split the build flags among the variables in the standard way;
 correctly declare all dependencies between source files; install
 localized man pages in the expected locations; get rid of the
 symlink hackery.
Forwarded: Marco Peereboom <marco@peereboom.us>
Author: Andrea Bolognani <eof@kiyuko.org>
Last-Update: 2012-01-24
Index: scrotwm.git/linux/Makefile
===================================================================
--- scrotwm.git.orig/linux/Makefile	2012-01-24 22:49:31.709553412 +0100
+++ scrotwm.git/linux/Makefile	2012-01-24 22:50:15.818056739 +0100
@@ -1,47 +1,62 @@
-CFLAGS+= -Wall -ggdb -D_GNU_SOURCE -I.
-CFLAGS+= -DSWM_LIB=\"$(LIBDIR)/libswmhack.so.$(LVERS)\"
-LDADD+= -lX11 -lXrandr -lXtst
-
-PREFIX?= /usr/local
-BINDIR?= $(PREFIX)/bin
-LIBDIR?= $(PREFIX)/lib
-MANDIR?= $(PREFIX)/share/man
-
-CC= gcc
-
-LVERS= $(shell . ../lib/shlib_version; echo $$major.$$minor)
+PREFIX       ?= /usr/local
+BINDIR       ?= $(PREFIX)/bin
+LIBDIR       ?= $(PREFIX)/lib
+DATAROOTDIR  ?= $(PREFIX)/share
+MANDIR       ?= $(DATAROOTDIR)/man
+XSESSIONSDIR ?= $(DATAROOTDIR)/xsessions
+
+LVERS = $(shell . ../lib/shlib_version; echo $$major.$$minor)
+
+MAINT_CFLAGS   = -Wall -ggdb
+MAINT_CPPFLAGS = -I. -D_GNU_SOURCE -DSWM_LIB=\"$(LIBDIR)/libswmhack.so.$(LVERS)\"
+MAINT_LDLIBS   = -lX11 -lXrandr -lXtst
 
 all: scrotwm libswmhack.so.$(LVERS)
 
-scrotwm.c:
-	ln -sf ../scrotwm.c
-	ln -sf ../version.h
-
-swm_hack.c:
-	ln -sf ../lib/swm_hack.c
-
 scrotwm: scrotwm.o linux.o
-	$(CC) $(LDFLAGS) -o $@ $+ $(LDADD)
+	$(CC) $(MAINT_LDFLAGS) $(LDFLAGS) $+ -o $@ $(MAINT_LDLIBS) $(LDLIBS)
+
+scrotwm.o: ../scrotwm.c ../version.h
+	$(CC) $(MAINT_CFLAGS) $(CFLAGS) $(MAINT_CPPFLAGS) $(CPPFLAGS) -c $< -o $@
 
-%.so: %.c
-	$(CC) $(CFLAGS) -c -fpic -DPIC $+ -o $@
+linux.o: linux.c util.h
+	$(CC) $(MAINT_CFLAGS) $(CFLAGS) $(MAINT_CPPFLAGS) $(CPPFLAGS) -c $< -o $@
 
 libswmhack.so.$(LVERS): swm_hack.so
-	$(CC) -shared -fpic -o libswmhack.so.$(LVERS) swm_hack.so $(LDADD)
+	$(CC) $(MAINT_LDFLAGS) $(LDFLAGS) -shared -fpic $+ -o $@ $(MAINT_LDLIBS) $(LDLIBS)
+
+swm_hack.so: ../lib/swm_hack.c
+	$(CC) $(MAINT_CFLAGS) $(CFLAGS) $(MAINT_CPPFLAGS) $(CPPFLAGS) -c -fpic -DPIC $< -o $@
+
+clean:
+	rm -f scrotwm *.o libswmhack.so.* *.so
 
 install: all
 	install -m 755 -d $(DESTDIR)$(BINDIR)
 	install -m 755 -d $(DESTDIR)$(LIBDIR)
 	install -m 755 -d $(DESTDIR)$(MANDIR)/man1
-	install -m 755 scrotwm $(DESTDIR)$(BINDIR)
-	install -m 755 libswmhack.so.$(LVERS) $(DESTDIR)$(LIBDIR)
-	install -m 644 ../scrotwm.1 $(DESTDIR)$(MANDIR)/man1/scrotwm.1
-	install -m 644 ../scrotwm_es.1 $(DESTDIR)$(MANDIR)/man1/scrotwm_es.1
-	install -m 644 ../scrotwm_it.1 $(DESTDIR)$(MANDIR)/man1/scrotwm_it.1
-	install -m 644 ../scrotwm_pt.1 $(DESTDIR)$(MANDIR)/man1/scrotwm_pt.1
-	install -m 644 ../scrotwm_ru.1 $(DESTDIR)$(MANDIR)/man1/scrotwm_ru.1
-
-clean:
-	rm -f scrotwm *.o *.so libswmhack.so.* scrotwm.c swm_hack.c
+	install -m 755 -d $(DESTDIR)$(MANDIR)/es/man1
+	install -m 755 -d $(DESTDIR)$(MANDIR)/it/man1
+	install -m 755 -d $(DESTDIR)$(MANDIR)/pt/man1
+	install -m 755 -d $(DESTDIR)$(MANDIR)/ru/man1
+	install -m 755 -d $(DESTDIR)$(XSESSIONSDIR)
+	install -m 755 scrotwm                $(DESTDIR)$(BINDIR)
+	install -m 644 libswmhack.so.$(LVERS) $(DESTDIR)$(LIBDIR)
+	install -m 644 ../scrotwm.1           $(DESTDIR)$(MANDIR)/man1/scrotwm.1
+	install -m 644 ../scrotwm_es.1        $(DESTDIR)$(MANDIR)/es/man1/scrotwm.1
+	install -m 644 ../scrotwm_it.1        $(DESTDIR)$(MANDIR)/it/man1/scrotwm.1
+	install -m 644 ../scrotwm_pt.1        $(DESTDIR)$(MANDIR)/pt/man1/scrotwm.1
+	install -m 644 ../scrotwm_ru.1        $(DESTDIR)$(MANDIR)/ru/man1/scrotwm.1
+	install -m 644 scrotwm.desktop        $(DESTDIR)$(XSESSIONSDIR)
+
+uninstall:
+	rm -f $(DESTDIR)$(BINDIR)/scrotwm
+	rm -f $(DESTDIR)$(LIBDIR)/libswmhack.so.$(LVERS)
+	rm -f $(DESTDIR)$(MANDIR)/man1/scrotwm.1
+	rm -f $(DESTDIR)$(MANDIR)/es/man1/scrotwm.1
+	rm -f $(DESTDIR)$(MANDIR)/it/man1/scrotwm.1
+	rm -f $(DESTDIR)$(MANDIR)/pt/man1/scrotwm.1
+	rm -f $(DESTDIR)$(MANDIR)/ru/man1/scrotwm.1
+	rm -f $(DESTDIR)$(XSESSIONSDIR)/scrotwm.desktop
 
-.PHONY: all install clean
+.PHONY: all clean install uninstall
